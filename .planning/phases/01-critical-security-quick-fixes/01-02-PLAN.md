---
phase: 01-critical-security-quick-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - pages/index.tsx
  - pages/filmography/[movieId].tsx
autonomous: true

must_haves:
  truths:
    - "Home page poster fetching uses proper async/await pattern without anti-patterns"
    - "Review input focuses only on component mount, not on every state update"
  artifacts:
    - path: "pages/index.tsx"
      provides: "Home page with proper async data fetching"
      contains: "const fetchPoster = async"
    - path: "pages/filmography/[movieId].tsx"
      provides: "Movie detail page with correct focus management"
      contains: "useEffect(() => {"
  key_links:
    - from: "pages/index.tsx"
      to: "TMDB API"
      via: "async/await in useEffect"
      pattern: "await Axios\\.get"
    - from: "pages/filmography/[movieId].tsx"
      to: "reviewRef.current"
      via: "focus() on mount only"
      pattern: "reviewRef\\.current\\?\\.focus\\(\\)"
---

<objective>
Fix async anti-pattern in home page useEffect and separate review input focus management into mount-only effect, eliminating code quality issues that could lead to bugs.

Purpose: Prevent potential race conditions and unwanted focus behavior
Output: Clean async/await pattern for poster fetching, separated useEffect hooks for focus management
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-security-quick-fixes/01-CONTEXT.md
@pages/index.tsx
@pages/filmography/[movieId].tsx
</context>

<tasks>

<task type="auto">
  <name>Refactor home page useEffect to proper async/await pattern</name>
  <files>pages/index.tsx</files>
  <action>
Replace the async anti-pattern in useEffect (lines 17-32) where a promise is created and then awaited inside an unnecessary async wrapper.

Current problematic pattern:
```typescript
const getPoster = Axios.get(...); // Promise created but not awaited
const data = async () => {
  await getPoster; // Awaiting in wrapper
};
data(); // Not awaiting this call
```

Replace with proper pattern:
```typescript
useEffect(() => {
  const fetchPoster = async () => {
    try {
      const res = await Axios.get(
        `https://api.themoviedb.org/3/collection/${process.env.NEXT_PUBLIC_TMDB_COLLECTION_ID}?api_key=${process.env.NEXT_PUBLIC_TMDB_API_KEY}`
      );
      const baseURL = "https://image.tmdb.org/t/p/original";
      setPoster(baseURL + res.data.poster_path);
    } catch (err) {
      console.error("Failed to load poster:", err);
      // Graceful degradation - poster remains null/undefined
    }
  };

  fetchPoster();
}, []);
```

Keep empty dependency array `[]` to run only on mount. Add error handling to prevent crashes on API failures.
  </action>
  <verify>
grep -A 15 "useEffect" pages/index.tsx shows proper async/await pattern with try/catch
grep "const getPoster = Axios.get" pages/index.tsx returns no results (anti-pattern removed)
npm run build succeeds without warnings
  </verify>
  <done>Home page useEffect uses proper async function declaration, awaits Axios call directly, includes error handling, and runs only on mount</done>
</task>

<task type="auto">
  <name>Fix review input focus management to focus only on mount</name>
  <files>pages/filmography/[movieId].tsx</files>
  <action>
Separate the focus management logic from review update logic. Currently, the useEffect at lines 93-99 has `review` in its dependency array, causing focus to trigger on every review state change.

Identify the current useEffect that contains `reviewRef.current?.focus()` with `[review]` or similar dependencies.

Split into two separate useEffects:

1. Mount-only effect for initial focus (empty dependency array):
```typescript
useEffect(() => {
  // Focus input on mount if user is logged in
  const userEmail = localStorage.getItem("userEmail");
  if (userEmail && reviewRef.current) {
    reviewRef.current.focus();
  }
}, []); // Empty deps - runs once on mount
```

2. Keep existing effect for review retrieval/updates with appropriate dependencies, but remove focus() call from it.

This follows React best practices: separate effects for separate concerns (mount behavior vs. state-driven behavior).
  </action>
  <verify>
grep -B 2 -A 5 "reviewRef.current?.focus()" pages/filmography/[movieId].tsx shows effect with empty dependency array
grep -c "useEffect" pages/filmography/[movieId].tsx shows count increased by 1 (original effect + new mount effect)
npm run dev and manually test: input focuses once on mount, NOT on every keystroke
  </verify>
  <done>Review input focus happens only on component mount with empty dependency array, not on every review state update</done>
</task>

</tasks>

<verification>
Run code quality checks:
- `npm run lint` passes with no warnings about useEffect dependencies
- `npm run build` succeeds
- Manual test: Load home page, poster loads correctly
- Manual test: Load movie detail page, input focuses once, typing doesn't re-focus
</verification>

<success_criteria>
- Home page poster fetch uses clean async/await pattern with error handling
- Review input focuses only once on mount, not on state updates
- No console errors during normal operation
- All existing functionality continues working
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security-quick-fixes/01-02-SUMMARY.md`
</output>
